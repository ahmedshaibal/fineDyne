<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html>
<head>
	<title>FineDyne</title>

	<meta itemprop="name" content="FineDyne"/>
	<meta itemprop="description" content="FineDyne"/>

	<meta charset="UTF-8">

	<link type="text/css" href="css/leaflet.css" rel="stylesheet"/>
	<link type="text/css" href="css/MarkerCluster.Default.css" rel="stylesheet"/>
	<link type="text/css" href="css/MarkerCluster.css" rel="stylesheet"/>
	<link type="text/css" href="css/dc.css" rel="stylesheet"/>
	<link type="text/css" href="css/leaflet-legend.css" rel="stylesheet"/>

  <style>
    .map {
      width:700px;
      height:500px;
    }
    .pie {
      margin-right:30px;
    }

    /*map legend styling*/
    /*--*/
  </style>
</head>
<body>

	<div id="priceRange">
			 <fieldset>
		     <label for="checkbox-nested-1">$
		       <input type="checkbox" name="checkbox-nested-1" id="checkbox-1">
		     </label>
		     <label for="checkbox-nested-2">$$
		       <input type="checkbox" name="checkbox-nested-2" id="checkbox-2">
		     </label>
		     <label for="checkbox-nested-3">$$$
		       <input type="checkbox" name="checkbox-nested-3" id="checkbox-3">
		     </label>
		     <label for="checkbox-nested-4">$$$$
		       <input type="checkbox" name="checkbox-nested-4" id="checkbox-4">
		     </label>
		   </fieldset>

	</div>

<div id="demo1">
    <h2>FineDyne in Toronto</h2>
		<div class="pie"></div>
    <div class="map"></div>
</div>


<link rel="stylesheet" href="//code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css">
<script src="https://code.jquery.com/jquery-1.12.4.js"></script>
<script src="https://code.jquery.com/ui/1.12.1/jquery-ui.js"></script>

<script type="text/javascript" src="js/d3.js"></script>
<script type="text/javascript" src="js/crossfilter.js"></script>
<script type="text/javascript" src="js/dc.js"></script>
<script type="text/javascript" src="js/leaflet.js"></script>
<script src="js/colorbrewer.js"></script>

<!--Optional-->
<script type="text/javascript" src="js/leaflet.markercluster.js"></script>

<script type="text/javascript" src="js/dc.leaflet.js"></script>
<script type="text/javascript">



	var selected = [];
	$('#priceRange input:checked').each(function() {
		selected.push($(this).attr('id'));
	});
  /*     Markers      */

  d3.csv("italian.csv", function(data) {
      drawMarkerSelect(data);
      //drawMarkerArea(data);
  });

  function drawMarkerSelect(data) {
      var xf = crossfilter(data);
      var groupname = "marker-select";

			var prices = xf.dimension(function(d) {
				//if (d.price_range == 2) {
					 return d.price_range;
				//} else return;
			}).filter(
				function (d) {
					/*if (selected.length == 0){
						console.log("nothing selected");
						return d;
					} else {
*/
					//selected.forEach(
					//	function(price){
							if (d == 1)
							//console.log("selected - " + price.value);
								return d;
					//	}
					//)
				//}

				}
			);

			var restaurantNames  = xf.dimension(function(d) {
				return d.name;
			});

      var restaurantsGroup = restaurantNames.group().reduce(
					function(p, v) { // add
					p.name = v.name;
					p.price_range = v.price_range;
					p.stars = v.stars;
					p.latitude = v.latitude;
					p.longitude = v.longitude;
	        ++p.count;
	        return p;
	    		},
	    		function(p, v) { // remove
	        	--p.count;
	        	return p;
	    		},
	    		function() { // init
	        	return {count: 0};
	    		}
			);

      var marker = dc_leaflet.markerChart("#demo1 .map", groupname) //map formatting
          .dimension(restaurantNames)
          .group(restaurantsGroup)
          .width(700) //was 600
          .height(500)
          .center([43.733372, -79.354782]) //was 42.69,25.42
          .zoom(11) //was 7s
          .cluster(true) //was true
					.valueAccessor(function(kv) {
			         return kv.value.count;
			    })
			    .locationAccessor(function(kv) {
						return [kv.value.latitude,kv.value.longitude]	;
			    })
          .popup(function(kv,marker) {
              return kv.value.name + " - " + kv.value.stars + " * - "  + kv.value.price_range + "$";
          });

					var stars = xf.dimension(function(d) {
							return d.stars;
						});
		      var starsGroup = stars.group().reduceCount();
					//var filterPrice =

		      var pie = dc.pieChart("#demo1 .pie",groupname)
		          .dimension(stars)
		          .group(starsGroup)
							//.filter()
		          .width(200) //was 200
		          .height(200)
		          .renderLabel(true) //was true
		          .renderTitle(true) //was true
		          .ordering(function (p) {
		              return -p.value; //was -p.value
		          });

      dc.renderAll(groupname);
      return {marker: marker, pie: pie};
  }

</script>

</body>
</html>
