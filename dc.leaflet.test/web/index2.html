<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html>
<head>
	<title>FineDyne</title>

	<meta itemprop="name" content="FineDyne"/>
	<meta itemprop="description" content="FineDyne"/>

	<meta charset="UTF-8">

	<link type="text/css" href="css/leaflet.css" rel="stylesheet"/>
	<link type="text/css" href="css/MarkerCluster.Default.css" rel="stylesheet"/>
	<link type="text/css" href="css/MarkerCluster.css" rel="stylesheet"/>
	<link type="text/css" href="css/dc.css" rel="stylesheet"/>
	<link type="text/css" href="css/leaflet-legend.css" rel="stylesheet"/>

	<link rel="stylesheet" href="//code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css">
	<script src="https://code.jquery.com/jquery-1.12.4.js"></script>
  <script src="https://code.jquery.com/ui/1.12.1/jquery-ui.js"></script>

  <style>
    #holder {
      width:850px;
      margin:20px auto;
    }
    #holder>div {
      padding:30px 0;
      clear:both;
    }
    .map {
      width:600px;
      height:400px;
    }
    .pie {
      margin-left:30px;
    }

    /*map legend styling*/
    /*--*/
  </style>
</head>
<body>




<div id="priceRange">
		 <fieldset>
	     <label for="checkbox-nested-1">$
	       <input type="checkbox" name="checkbox-nested-1" id="checkbox-1">
	     </label>
	     <label for="checkbox-nested-2">$$
	       <input type="checkbox" name="checkbox-nested-2" id="checkbox-2">
	     </label>
	     <label for="checkbox-nested-3">$$$
	       <input type="checkbox" name="checkbox-nested-3" id="checkbox-3">
	     </label>
	     <label for="checkbox-nested-4">$$$$
	       <input type="checkbox" name="checkbox-nested-4" id="checkbox-4">
	     </label>
	   </fieldset>

</div>

<div id="holder">
	  <div id="demo1">
    		<h2>FineDyne in Toronto</h2>
    		<div class="map"></div>
    		<div class="pie"></div>
		</div>

</div>

<script type="text/javascript" src="js/d3.js"></script>
<script type="text/javascript" src="js/crossfilter.js"></script>
<script type="text/javascript" src="js/dc.js"></script>
<script type="text/javascript" src="js/leaflet.js"></script>
<script src="js/colorbrewer.js"></script>

<!--Optional-->
<script type="text/javascript" src="js/leaflet.markercluster.js"></script>
<script type="text/javascript" src="js/dc.leaflet.js"></script>

<!--- dc-addons -->
<!-- <link rel="stylesheet" href="../bower_components/leaflet/dist/leaflet.css" />
<script src="../bower_components/leaflet/dist/leaflet.js"></script>

<link rel="stylesheet" href="../bower_components/leaflet.markercluster/dist/MarkerCluster.css" />
<link rel="stylesheet" href="../bower_components/leaflet.markercluster/dist/MarkerCluster.Default.css" />
<script src="../bower_components/leaflet.markercluster/dist/leaflet.markercluster.js"></script>

<script src="../bower_components/dc-addons/dist/leaflet-map/dc-leaflet.min.js"></script> -->

<script type="text/javascript">
	var selected = [];
	$('#priceRange input:checked').each(function() {
    	selected.push($(this).attr('id'));
	});



  /*     Markers      */

  d3.csv("italian.csv", function(data) {
      drawMarkerSelect(data);
      //drawMarkerArea(data);
  });

  function drawMarkerSelect(data) {
      var xf = crossfilter(data);
      var groupname = "marker-select";

			var prices = xf.dimension(function(d) {
				//if (d.price_range == 2) {
					 return d.price_range;
				//} else return;
			}).filter(
				function (d) {
					if (selected.length == 0){
						console.log("nothing selected");
						return d;
					} else {

					selected.forEach(
						function(price){
							if (d == price.value)
							console.log("selected - " + price.value);
								return d;
						}
					)
				}

				}
			);

			var restaurantNames  = xf.dimension(function(d) {
				return d.name;
			});

      var restaurantsGroup = restaurantNames.group().reduce(
					function(p, v) { // add
					p.latitude = v.latitude;
					p.longitude = v.longitude;
	        ++p.count;
	        return p;
	    		},
	    		function(p, v) { // remove
	        	--p.count;
	        	return p;
	    		},
	    		function() { // init
	        	return {count: 0};
	    		}
			);

			var leafMap = dc_leaflet.markerChart("#demo1 .map",groupname)
					.dimension(restaurantNames)
					.group(restaurantsGroup)
					.width(700) //was 600
					.height(500)
					.center([43.733372, -79.354782]) //was 42.69,25.42
					.zoom(11) //was 7s
					.cluster(true) //was true
			    .valueAccessor(function(kv) {
			         return kv.value.count;
			    })
			    .locationAccessor(function(kv) {
						return [kv.value.latitude,kv.value.longitude]	;
			    })
			    .popup(function(kv, d) {
						return [kv.value.latitude,kv.value.longitude].join("-")
			    });

					/*var popLocation= new L.LatLng(3.733372, -79.354782);
					var popup = L.popup()
					    .setLatLng(popLocation)
					    .setContent('<p>Hello world!<br />This is a nice popup.</p>')
					    .openOn(leafMap);*/


      var stars = xf.dimension(function(d) {
					return d.stars;
				});
      var starsGroup = stars.group().reduceCount();
			//var filterPrice =

      var pie = dc.pieChart("#demo1 .pie",groupname)
          .dimension(stars)
          .group(starsGroup)
					//.filter()
          .width(200) //was 200
          .height(200)
          .renderLabel(true) //was true
          .renderTitle(true) //was true
          .ordering(function (p) {
              return -p.value; //was -p.value
          });

      dc.renderAll(groupname);
  }
/*
  function drawMarkerArea(data) {
      var xf = crossfilter(data);
      var groupname = "marker-area";
      var facilities = xf.dimension(function(d) { return d.geo; });
      var facilitiesGroup = facilities.group().reduceCount();

      var marker = dc_leaflet.markerChart("#demo2 .map",groupname)
          .dimension(facilities)
          .group(facilitiesGroup)
          .width(600)
          .height(400)
          .center([42.69,25.42])
          .zoom(7)
          .renderPopup(false)
          .filterByArea(true);

      var types = xf.dimension(function(d) { return d.type; });
      var typesGroup = types.group().reduceCount();

      var pie = dc.pieChart("#demo2 .pie",groupname)
          .dimension(types)
          .group(typesGroup)
          .width(200)
          .height(200)
          .renderLabel(true)
          .renderTitle(true)
          .ordering(function (p) {
              return -p.value;
          });

      dc.renderAll(groupname);
      return {marker: marker, pie: pie};
  }
*/
/*
  var demo2_geojson=false;
  var demo2=false;

  d3.json("bulgaria.geojson", function(data) {
      demo2_geojson=data;
      if (demo2)
          drawChoropleth(demo2,demo2_geojson);
  });
  d3.csv("demo2.csv", function(data) {
      demo2=data;
      if (demo2_geojson)
          drawChoropleth(demo2,demo2_geojson);
  });
}

  /*     Choropleth      */
/*
  function drawChoropleth(data,geojson) {
      dataP = [];
      data.filter(function(d) {
          return d.code && d.code!='SOF46';
      }).forEach(function(d) {
          d.sum = 0;
          for(var p in d)
              if (p && p!="code" && p!="sum") {
                  dataP.push({'code':d.code,'type':p,'value':+d[p]});
                  d.sum+=+d[p];
              }
      });
      delete data;

      var xf = crossfilter(dataP);
      var groupname = "Choropleth";
      var facilities = xf.dimension(function(d) { return d.code; });
      var facilitiesGroup = facilities.group().reduceSum(function(d) { return d.value;});

      var choro = dc_leaflet.choroplethChart("#demo3 .map",groupname)
          .dimension(facilities)
          .group(facilitiesGroup)
          .width(600)
          .height(400)
          .center([42.69,25.42])
          .zoom(7)
          .geojson(geojson)
          .colors(colorbrewer.YlGnBu[7])
          .colorDomain([
              d3.min(facilitiesGroup.all(), dc.pluck('value')),
              d3.max(facilitiesGroup.all(), dc.pluck('value'))
          ])
          .colorAccessor(function(d,i) {
              return d.value;
          })
          .featureKeyAccessor(function(feature) {
              return feature.properties.code;
          })
          .renderPopup(true)
          .popup(function(d,feature) {
              return feature.properties.nameEn+" : "+d.value;
          })
          .legend(dc_leaflet.legend().position('bottomright'));


      var types = xf.dimension(function(d) { return d.type; });
      var typesGroup = types.group().reduceSum(function(d) { return d.value;});

      var pie = dc.pieChart("#demo3 .pie",groupname)
          .dimension(types)
          .group(typesGroup)
          .width(200)
          .height(200)
          .ordering(function (p) {
              return +p.key.substr(6);
          })
          .renderLabel(false)
          .renderTitle(true)
          .title(function(d) {
              var age = d.key.substr(6);
              if (age.indexOf("p")==-1)
                  age="Between "+(+age-4)+"-"+age;
              else
                  age="Over "+age.substr(0,2);
              return age+" : "+d.value;
          });

      dc.renderAll(groupname);
      return {choro: choro, pie: pie};
  }*/
</script>

</body>
</html>
